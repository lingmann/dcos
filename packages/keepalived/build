#!/bin/bash

mkdir -p "/build"

export CFLAGS=-I/opt/mesosphere/include
export LDFLAGS="-L/opt/mesosphere/lib -Wl,-rpath=/opt/mesosphere/lib"
export CXXFLAGS=-I/opt/mesosphere/include

#pushd "/pkg/src/linux"
#popd

#pushd "/pkg/src/flex"
#./configure \
#  "--prefix=$PKG_PATH"
#make -j8
#make install
#popd

#pushd "/pkg/src/bison"
#./configure \
#  "--prefix=$PKG_PATH"
#make -j8
#make install
#popd

#pushd "/pkg/src/popt"
#./configure \
#  "--prefix=$PKG_PATH"
#make -j8
#make install
#popd

#pushd "/pkg/src/libnl"
#./configure \
#  "--prefix=$PKG_PATH"
#make -j8
#make install
#popd

apt-get update
apt-get -y install libnl-3-dev libnl-genl-3-dev libpopt-dev linux-headers-3.19.0-21-generic pkg-config

pushd "/pkg/src/keepalived"
./configure \
  "--prefix=$PKG_PATH" \
  "--enable-sha1"
make -j8
make install
popd

# copy libs
mkdir -p "$PKG_PATH/lib"
cp /lib/x86_64-linux-gnu/libnl-genl-3.so.200 "$PKG_PATH/lib/libnl-genl-3.so.200"
cp /lib/x86_64-linux-gnu/libnl-3.so.200 "$PKG_PATH/lib/libnl-3.so.200"

# remove examples and unused config
rm -rf "$PKG_PATH/etc/rc.d/"
rm -rf "$PKG_PATH/etc/sysconfig/"
rm -rf "$PKG_PATH/etc/keepalived/samples/"
rm -f "$PKG_PATH/etc/keepalived/keepalived.conf"

# write keepalived config
# todo <lloesche>: just an example config. Must be generated somewhere else
#                  or @KEEPALIVED_*@ placeholders replaced.
keepalived_config="$PKG_PATH/etc/keepalived/keepalived.conf.template"
mkdir -p "$(dirname "$keepalived_config")"
cat <<EOF > "$keepalived_config"
vrrp_script chk_http_port {
    script "</dev/tcp/127.0.0.1/80"
    interval 1
    weight -2
}

vrrp_instance VI_1 {
    state EQUAL
    interface @KEEPALIVED_INTERFACE@
    virtual_router_id @KEEPALIVED_ROUTER_ID@
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass @KEEPALIVED_PASS@
    }
    virtual_ipaddress {
        @KEEPALIVED_VIRTUAL_IPADDRESS@
    }

    track_script {
       chk_http_port
    }
}
EOF

keepalived_wrapper="$PKG_PATH/sbin/keepalived.wrapper"
cat <<EOF > "$keepalived_wrapper"
#!/bin/bash
. /etc/mesosphere/keepalived
/bin/sed -e "s/@KEEPALIVED_INTERFACE@/\${KEEPALIVED_INTERFACE}/" \
         -e "s/@KEEPALIVED_ROUTER_ID@/\${KEEPALIVED_ROUTER_ID}/" \
         -e "s/@KEEPALIVED_PASS@/\${KEEPALIVED_PASS}/" \
         -e "s/@KEEPALIVED_VIRTUAL_IPADDRESS@/\${KEEPALIVED_VIRTUAL_IPADDRESS}/" \
         "$PKG_PATH/etc/keepalived/keepalived.conf.template" > "$PKG_PATH/etc/keepalived/keepalived.conf"
exec $PKG_PATH/sbin/keepalived \$*
EOF
chmod 700 "$keepalived_wrapper"

systemd_master="$PKG_PATH"/dcos.target.wants_master/keepalived.service
mkdir -p "$(dirname "$systemd_master")"
cat <<EOF > "$systemd_master"
[Unit]
Description=LVS and VRRP High Availability Monitor
After=syslog.target network.target
ConditionPathExists=/etc/mesosphere/keepalived

[Service]
Restart=on-failure
StartLimitInterval=0
RestartSec=5
EnvironmentFile=/etc/environment
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/etc/mesosphere/keepalived
ExecStart=$PKG_PATH/sbin/keepalived.wrapper -n -f $PKG_PATH/etc/keepalived/keepalived.conf \$KEEPALIVED_OPTIONS
EOF
