#!/bin/bash

mkdir -p "$PKG_PATH/usr/"

cp -rp /pkg/src/cosmos/cosmos-*-one-jar.jar "$PKG_PATH/usr/cosmos.jar"
sudo chmod -R o+r "$PKG_PATH/usr"

cosmos_service="$PKG_PATH/dcos.target.wants_master/dcos-cosmos.service"
mkdir -p $(dirname "$cosmos_service")

cat <<EOF > "$cosmos_service"
[Unit]
Description=Package Service: DCOS Packaging API
After=dcos-mesos-master.service
After=dcos-gen-resolvconf.service

[Service]
Restart=always
StartLimitInterval=0
RestartSec=15
EnvironmentFile=/opt/mesosphere/environment
ExecStartPre=/bin/ping -c1 ready.spartan
ExecStartPre=/opt/mesosphere/bin/exhibitor_wait.py
## CoreOS
ExecStartPre=-/usr/bin/mkdir -p /var/lib/cosmos
## Ubuntu
ExecStartPre=-/bin/mkdir -p /var/lib/cosmos
ExecStart=/opt/mesosphere/bin/java -Xmx2G -jar "$PKG_PATH/usr/cosmos.jar"
EOF
