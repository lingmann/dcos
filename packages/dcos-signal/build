#!/bin/bash
export PATH=/opt/mesosphere/bin:$PATH
export LIB_INSTALL_DIR="$PKG_PATH/lib/python3.4/site-packages"
export PYTHONPATH="/opt/mesosphere/lib/python3.4/site-packages:$LIB_INSTALL_DIR"
export LD_LIBRARY_PATH=/opt/mesosphere/lib

mkdir -p "$LIB_INSTALL_DIR"

# Build the dcos-signal service
pushd /pkg/src/dcos-signal
python3 setup.py install --root=/ --prefix=$PKG_PATH

# Create the service file
service="$PKG_PATH/dcos.target.wants_master/dcos-signal.service"
mkdir -p "$(dirname "$service")"
cat <<EOF > "$service"
[Unit]
Description=DCOS Tracking
After=mesos-master.service
[Service]
Restart=on-failure
StartLimitInterval=0
RestartSec=5
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/opt/mesosphere/etc/cloudenv
ExecStartPre=/bin/ping -c1 leader.mesos
ExecStart=/opt/mesosphere/bin/dcos-signal --write_key=51ybGTeFEFU1xo6u10XMDrr6kATFyRyh
EOF

service_timer="$PKG_PATH/dcos.target.wants/dcos-signal.timer"
mkdir -p "$(dirname "$service_timer")"
cat <<'EOF' > "$service_timer"
[Unit]
Description=Tracking every interval
[Timer]
OnCalendar=hourly
Unit=dcos-signal.service
EOF
