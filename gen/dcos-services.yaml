- name: dcos-link-env.service
  command: start
  content: |
    [Unit]
    Before=dcos.target
    [Service]
    Type=oneshot
    ExecStartPre=/usr/bin/mkdir -p /etc/profile.d
    ExecStart=/usr/bin/ln -sf /opt/mesosphere/environment.export /etc/profile.d/dcos.sh
- name: dcos-download.service
  content: |
    [Unit]
    Description=Download the DCOS
    After=network-online.target
    Wants=network-online.target
    ConditionPathExists=!/opt/mesosphere/
    [Service]
    EnvironmentFile=/etc/mesosphere/setup-flags/bootstrap-id
    Type=oneshot
    ExecStartPre=/usr/bin/bash -c "until curl -C - -o /tmp/bootstrap.tar.xz {{ bootstrap_url }}/bootstrap/${BOOTSTRAP_ID}.bootstrap.tar.xz; do echo 'failed to download'; sleep 5; done"
    ExecStartPre=/usr/bin/mkdir -p /opt/mesosphere
    ExecStart=/usr/bin/tar -axf /tmp/bootstrap.tar.xz -C /opt/mesosphere
    ExecStartPost=-/usr/bin/rm -f /tmp/bootstrap.tar.xz
- name: dcos-setup.service
  command: start
  enable: true
  content: |
    [Unit]
    Description=Prep the Pkgpanda working directories for this host.
    Requires=dcos-download.service
    After=dcos-download.service
    [Service]
    Type=oneshot
    EnvironmentFile=/opt/mesosphere/environment
    ExecStart=/opt/mesosphere/bin/pkgpanda setup --no-block-systemd
    [Install]
    WantedBy=multi-user.target
