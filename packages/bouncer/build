#!/bin/bash
source /opt/mesosphere/environment.export
export LIB_INSTALL_DIR="$PKG_PATH/lib/python3.4/site-packages"
mkdir -p "$LIB_INSTALL_DIR"

# Install wheels.
for package in jsonschema pyjwt kazoo ldap3 pyasn1; do
  pip3 install --no-deps --no-index --target="$LIB_INSTALL_DIR" /pkg/src/$package/*.whl
done

# Install gunicorn (is an extracted archive).
pip3 install --no-deps --install-option="--prefix=$PKG_PATH" --root=/ /pkg/src/gunicorn

# Install python-mimeparse (is an extracted archive).
pip3 install --no-deps --install-option="--prefix=$PKG_PATH" --root=/ /pkg/src/python-mimeparse

# Install falcon (is an extracted archive)
# TODO(jp): set up Cython before installing, for speed-up.
pip3 install --no-deps --install-option="--prefix=$PKG_PATH" --root=/ /pkg/src/falcon

# TODO(cmaloney): Make bouncer install as a proper python package.
# Install bouncer (only cp directory tree).
# TODO(jp): cherry-pick what is required.
cp -r "/pkg/src/bouncer" "$PKG_PATH/bouncer"

# Deploy service file.
SERVICE_FILE_NAME="dcos-gunicorn-bouncer.service"
SERVICE_FILE_PATH="$PKG_PATH/dcos.target.wants_master/${SERVICE_FILE_NAME}"
mkdir -p "$(dirname "$SERVICE_FILE_PATH")"
envsubst '$PKG_PATH' < "/pkg/extra/${SERVICE_FILE_NAME}" > "${SERVICE_FILE_PATH}"
