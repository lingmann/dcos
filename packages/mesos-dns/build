#!/bin/bash
set -x

# Setup go environment
mkdir -p /go/src/github.com/mesosphere
ln -s /pkg/src/mesos-dns /go/src/github.com/mesosphere/mesos-dns
export GOPATH=/go
export GOROOT=/pkg/src/go/
export PATH=$PATH:$GOROOT/bin:$GOPATH/bin

# Get the dependencies
go get github.com/tools/godep

# Build mesos-dns
pushd /go/src/github.com/mesosphere/mesos-dns
godep go build -ldflags="-X main.Version=v0.4.0" -o mesos-dns
popd

# TODO(cmaloney): PKG_PATH should always exist in the container
# Install to pkg-path
mkdir -p $PKG_PATH/bin
cp /go/src/github.com/mesosphere/mesos-dns/mesos-dns $PKG_PATH/bin/mesos-dns


# Create the service file
service="$PKG_PATH/dcos.target.wants_master/dcos-mesos-dns.service"
mkdir -p "$(dirname "$service")"
cp /pkg/extra/dcos-mesos-dns.service "$service"

resolvconf_service="$PKG_PATH/dcos.target.wants/dcos-gen-resolvconf.service"
mkdir -p "$(dirname "$resolvconf_service")"
cp /pkg/extra/dcos-gen-resolvconf.service "$resolvconf_service"

resolvconf_timer="$PKG_PATH/dcos.target.wants/dcos-gen-resolvconf.timer"
mkdir -p "$(dirname "$resolvconf_timer")"
cp /pkg/extra/dcos-gen-resolvconf.timer "$resolvconf_timer"

gen_resolvconf="$PKG_PATH/bin/gen_resolvconf.py"
cp /pkg/extra/gen_resolvconf.py "$gen_resolvconf"
chmod +x "$gen_resolvconf"
