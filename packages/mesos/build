#!/bin/bash
set -o errexit -o nounset -o pipefail

libdir="$PKG_PATH/lib"

# TODO(cmaloney): Check prerequisites installed (glog, protobuf, boost)
pushd "/pkg/src/mesos"
./bootstrap
popd

mkdir -p build
pushd build
# TODO(cmaloney): --with-glog=/usr --with-protobuf=/usr --with-boost=/usr
# TODO(cmaloney): DESTDIR builds so we don't have to build as root?
"/pkg/src/mesos/configure" \
  --prefix="$PKG_PATH" --enable-optimize --disable-python \
  --with-glog=/opt/mesosphere/active/mesos-buildenv \
  --with-protobuf=/opt/mesosphere/active/mesos-buildenv \
  --with-boost=/opt/mesosphere/active/mesos-buildenv \
# TODO(cmaloney): -j8 is almost certainly wrong.
make -j8

make install
popd

mkdir -p "$PKG_PATH/bin"
ln -s "$PKG_PATH/sbin/mesos-master" "$PKG_PATH/bin/mesos-master"
ln -s "$PKG_PATH/sbin/mesos-slave" "$PKG_PATH/bin/mesos-slave"

# TODO(cmaloney): Make these a seperate mesos library package.
# Copy the shared libraries from the system which mesos requires
cp /usr/lib/x86_64-linux-gnu/libsasl2.so.2 "$libdir"
cp /usr/lib/x86_64-linux-gnu/libsvn_delta-1.so.1 "$libdir"
cp /usr/lib/x86_64-linux-gnu/libsvn_subr-1.so.1 "$libdir"
cp /usr/lib/x86_64-linux-gnu/libapr-1.so.0 "$libdir"
cp /usr/lib/x86_64-linux-gnu/libaprutil-1.so.0 "$libdir"

# TODO(cmaloney): Shouldn't be needed...
#cp build/mesos-build/src/java/target/mesos-*.jar "$libdir"

systemd_master="$PKG_PATH"/dcos.target.wants_master/master.service
mkdir -p "$(dirname "$systemd_master")"
cat <<'EOF' > "$systemd_master"
[Unit]
Description=Mesos Master
After=zookeeper.service
Requires=zookeeper.service
[Service]
Restart=on-failure
EnvironmentFile=/etc/environment
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/opt/mesosphere/active/mesos-config/mesos-master
ExecStart=/opt/mesosphere/active/mesos/sbin/mesos-master
EOF

systemd_slave="$PKG_PATH"/dcos.target.wants_slave/slave.service
mkdir -p "$(dirname "$systemd_slave")"
cat <<'EOF' > "$systemd_slave"
[Unit]
Description=Mesos Slave
[Service]
Restart=on-failure
EnvironmentFile=/etc/environment
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/opt/mesosphere/active/mesos-config/mesos-slave
ExecStart=/opt/mesosphere/dcos/latest/mesos/sbin/mesos-slave
EOF

echo "Finished building Mesos"
