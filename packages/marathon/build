#!/bin/bash

mkdir -p "$PKG_PATH/usr/"

cp -rp /pkg/src/marathon/target/scala-2.11/marathon-assembly-*.jar "$PKG_PATH/usr/marathon.jar"

if [ "$PKG_VARIANT" = "ee" ]; then
  mkdir -p "$PKG_PATH/usr/plugins/lib"
  unzip /pkg/src/marathon-plugins/plugins.zip -d "$PKG_PATH/usr/plugins/lib"
  cat /pkg/src/marathon-plugin-conf/plugin-conf.json | sed -e 's|ACS_URL|http://127.0.0.1:8101|g' > "$PKG_PATH/usr/plugins/plugin-conf.json"
fi

sudo chmod -R o+r "$PKG_PATH/usr"

marathon_service="$PKG_PATH/dcos.target.wants_master/dcos-marathon.service"
mkdir -p $(dirname "$marathon_service")

cat <<EOF > "$marathon_service"
[Unit]
Description=Marathon
After=dcos-mesos-master.service
[Service]
Restart=always
StartLimitInterval=0
RestartSec=15
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=-/opt/mesosphere/environment.ip.marathon
ExecStartPre=/opt/mesosphere/bin/exhibitor_wait.py
ExecStartPre=/bin/bash -c 'echo "HOST_IP=\$(\$MESOS_IP_DISCOVERY_COMMAND)" > /opt/mesosphere/environment.ip.marathon'
ExecStartPre=/bin/bash -c 'echo "MARATHON_HOSTNAME=\$(\$MESOS_IP_DISCOVERY_COMMAND)" >> /opt/mesosphere/environment.ip.marathon'
ExecStartPre=/bin/bash -c 'echo "LIBPROCESS_IP=\$(\$MESOS_IP_DISCOVERY_COMMAND)" >> /opt/mesosphere/environment.ip.marathon'
EOF

if [ "$PKG_VARIANT" = "ee" ]; then
  cat << EOF >> "$marathon_service"
ExecStart=/opt/mesosphere/bin/java -Xmx2G -jar "$PKG_PATH/usr/marathon.jar" --plugin_dir "$PKG_PATH/usr/plugins/lib" --plugin_conf "$PKG_PATH/usr/plugins/plugin-conf.json" --zk zk://localhost:2181/marathon --master zk://localhost:2181/mesos --hostname "\$MARATHON_HOSTNAME" --default_accepted_resource_roles "*" --mesos_role "slave_public" --max_tasks_per_offer 100 --task_launch_timeout 86400000 --decline_offer_duration 300000 --revive_offers_for_new_apps --zk_compression --mesos_leader_ui_url "/mesos"
EOF
else
  cat << EOF >> "$marathon_service"
ExecStart=/opt/mesosphere/bin/java -Xmx2G -jar "$PKG_PATH/usr/marathon.jar" --zk zk://localhost:2181/marathon --master zk://localhost:2181/mesos --hostname "\$MARATHON_HOSTNAME" --default_accepted_resource_roles "*" --mesos_role "slave_public" --max_tasks_per_offer 100 --task_launch_timeout 86400000 --decline_offer_duration 300000 --revive_offers_for_new_apps --zk_compression --mesos_leader_ui_url "/mesos"
EOF
fi
