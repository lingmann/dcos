#!/bin/bash
set -o errexit -o nounset -o pipefail

mkdir -p "$PKG_PATH/usr/"

cp -rp /pkg/src/zookeeper "$PKG_PATH/usr"
sudo chmod -R o+r "$PKG_PATH/usr"

zookeeper_service="$PKG_PATH"/dcos.target.wants_master/zookeeper.service
mkdir -p "$(dirname "$zookeeper_service")"
cat <<'EOF' > "$zookeeper_service"
[Unit]
Description=Zookeeper
[Service]
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/opt/mesosphere/etc/cloudenv
EnvironmentFile=/opt/mesosphere/etc/zookeeper
Restart=on-failure
ExecStart=/usr/bin/docker run --rm \
  -p 2181:2181 -p 2888:2888 -p 3888:3888 \
  -p ${EXHIBITOR_WEB_UI_PORT}:${EXHIBITOR_WEB_UI_PORT} \
  --env-file=/opt/mesosphere/etc/cloudenv \
  --env-file=/opt/mesosphere/etc/zookeeper \
  thefactory/zookeeper-exhibitor:3.4.6_1.5.2
EOF
