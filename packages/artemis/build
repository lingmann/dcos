#!/bin/bash
export PATH=/opt/mesosphere/bin:$PATH
export LIB_INSTALL_DIR="$PKG_PATH/lib/python3.4/site-packages"
export PYTHONPATH="/opt/mesosphere/lib/python3.4/site-packages:$LIB_INSTALL_DIR"
export LD_LIBRARY_PATH=/opt/mesosphere/lib

mkdir -p "$LIB_INSTALL_DIR"

# Build the artemis service
pushd /pkg/src/artemis
python3 setup.py install --root=/ --prefix=$PKG_PATH

# Create the service file
service="$PKG_PATH/dcos.target.wants_aws_master/dcos-artemis.service"
mkdir -p "$(dirname "$service")"
cat <<EOF > "$service"
[Unit]
Description=DCOS Resize service (Artemis)
After=dcos-mesos-master.service
[Service]
Restart=always
StartLimitInterval=0
RestartSec=5
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/opt/mesosphere/etc/cloudenv
ExecStart=/opt/mesosphere/bin/artemis
EOF
