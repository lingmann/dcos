#!/bin/bash
export GOPATH=$GOPATH:/pkg
mkdir -p /pkg/src/github.com/mesosphere
# Create the GOPATH for the go tool to work properly
mv /pkg/src/dcos-signal /pkg/src/github.com/mesosphere/
cd /pkg/src/github.com/mesosphere/dcos-signal/

# Use the local Makefile which include ldflag overrides for version and revision
if [ "$PKG_VARIANT" = "ee" ]; then
  make install VARIANT=enterprise
else
  make install VARIANT=open
fi

# Copy the build from the bin to the correct place
cp -r /pkg/bin/ "$PKG_PATH"

# Create the service file
service="$PKG_PATH/dcos.target.wants_master/dcos-signal.service"
mkdir -p "$(dirname "$service")"
cp /pkg/extra/dcos-signal.service "$service"

# Create service timer
service_timer="$PKG_PATH/dcos.target.wants/dcos-signal.timer"
mkdir -p "$(dirname "$service_timer")"
if [ "$PKG_VARIANT" = "ee" ]; then
    cp /pkg/extra/dcos-signal-ee.timer "$service_timer"
else
    cp /pkg/extra/dcos-signal.timer "$service_timer"
fi
