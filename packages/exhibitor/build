#!/bin/bash
set -o errexit -o nounset -o pipefail

mkdir -p "$PKG_PATH/usr"
cp -rp "/pkg/src/zookeeper" "$PKG_PATH/usr"

exhibitor_path="$PKG_PATH"/usr/exhibitor
mkdir -p "$exhibitor_path"
pushd "$exhibitor_path"
cp /pkg/src/exhibitor/exhibitor-standalone/src/main/resources/buildscripts/standalone/maven/pom.xml .
mvn assembly:single
ln -s target/exhibitor-1.0-jar-with-dependencies.jar exhibitor.jar
rm pom.xml
popd

cat <<- EOF > "$PKG_PATH"/usr/exhibitor/defaults.conf
  zookeeper-data-directory=/var/lib/zookeeper/snapshot
  zookeeper-install-directory="$PKG_PATH"/usr/zookeeper
  zookeeper-log-directory=/var/lib/zookeeper/transactions
  log-index-directory=/var/lib/zookeeper/transactions
  cleanup-period-ms=300000
  check-ms=30000
  backup-period-ms=600000
  client-port=2181
  cleanup-max-files=20
  backup-max-store-ms=21600000
  connect-port=2888
  observer-threshold=0
  election-port=3888
  zoo-cfg-extra=tickTime\=2000&initLimit\=10&syncLimit\=5&quorumListenOnAllIPs\=true
  auto-manage-instances-settling-period-ms=0
  auto-manage-instances=1
EOF

exhibitor_service="$PKG_PATH/dcos.target.wants_master/exhibitor.service"
mkdir -p $(dirname "$exhibitor_service")
cat <<- EOF > "$exhibitor_service"
  [Unit]
  Description=Exhibitor Zookeeper Supervisor
  [Service]
  Restart=on-failure
  EnvironmentFile=/etc/environment
  EnvironmentFile=/opt/mesosphere/environment
  EnvironmentFile=/opt/mesosphere/etc/cloudenv
  EnvironmentFile=/opt/mesosphere/etc/zookeeper
  ExecStartPre=/bin/mkdir -p /var/lib/zookeeper/snapshot
  ExecStartPre=/bin/mkdir -p /var/lib/zookeeper/transactions
  ExecStartPre=/usr/bin/bash -c "echo com.netflix.exhibitor.s3.access-key-id=\$AWS_ACCESS_KEY_ID > /etc/mesosphere/exhibitor_credentials.properties"
  ExecStartPre=/usr/bin/bash -c "echo com.netflix.exhibitor.s3.access-secret-key=\$AWS_SECRET_ACCESS_KEY >> /etc/mesosphere/exhibitor_credentials.properties"
  ExecStart=/opt/mesosphere/bin/java -jar "$PKG_PATH/usr/exhibitor/exhibitor.jar" --port '\$EXHIBITOR_WEB_UI_PORT' --defaultconfig "$PKG_PATH/usr/exhibitor/defaults.conf" --configtype s3 --s3config '\${S3_BUCKET}:\${S3_PREFIX}' --s3credentials /etc/mesosphere/exhibitor_credentials.properties --s3region '\$AWS_REGION' --s3backup false --hostname '\$EC2_PUBLIC_HOSTNAME'
EOF
