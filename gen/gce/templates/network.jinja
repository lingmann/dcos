# Mesos Master Jinja Template
# Created M. Massenzio, 2015-04-27

{% set name = properties["network"]  %}
{% set zone =  properties["zone"] %}
{% set network_pool = properties["network_pool"] %}
{% set admin_range = properties["admin_range"] %}

resources:
    - type: compute.v1.network
      name: {{name}}
      properties:
        IPv4Range: {{network_pool}}

    - type: compute.v1.firewall
      name: {{ name }}-admin-access
      properties:
        allowed:
          - IPProtocol: TCP
            ports: [1-65535]
          - IPProtocol: UDP
            ports: [1-65535]
          - IPProtocol: ICMP
        sourceRanges: [ {{admin_range}} ]
        network: $(ref.{{name}}.selfLink)

    - type: compute.v1.firewall
      name: {{ name }}-allow-internal
      properties:
        allowed:
          - IPProtocol: TCP
            ports: [1-65535]
          - IPProtocol: UDP
            ports: [1-65535]
          - IPProtocol: ICMP
        sourceRanges: [ {{network_pool}} ]
        network: $(ref.{{name}}.selfLink)

    - type: compute.v1.firewall
      name: {{ name }}-allow-ssh
      properties:
        allowed:
          - IPProtocol: TCP
            ports: [22]
        sourceRanges: ["0.0.0.0/0"]
        network: $(ref.{{properties["network"]}}.selfLink)

    - type: compute.v1.firewall
      name: {{ name }}-allow-http
      properties:
        allowed:
          - IPProtocol: TCP
            ports: [80]
        sourceRanges: ["0.0.0.0/0"]
        targetTags: ["http-server"]
        network: $(ref.{{properties["network"]}}.selfLink)
