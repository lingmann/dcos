#!/bin/bash
set -x

# Setup go environment
mkdir -p /go/src/github.com/mesosphere
ln -s /pkg/src/mesos-dns /go/src/github.com/mesosphere/mesos-dns
export GOPATH=/go
export GOROOT=/pkg/src/go/
export PATH=$PATH:$GOROOT/bin

# Get the dependencies
go get github.com/gogo/protobuf/proto
go get github.com/golang/glog
go get github.com/mesos/mesos-go/detector
go get github.com/mesos/mesos-go/mesosproto
go get github.com/mesos/mesos-go/mesosutil
go get github.com/mesos/mesos-go/upid
go get github.com/miekg/dns
go get github.com/samuel/go-zookeeper/zk
go get github.com/stretchr/objx
go get github.com/stretchr/testify/assert
go get github.com/stretchr/testify/mock
go get golang.org/x/net/context

# Build mesos-dns
pushd /go/src/github.com/mesosphere/mesos-dns
go build
popd

# TODO(cmaloney): PKG_PATH should always exist in the container
# Install to pkg-path
mkdir -p $PKG_PATH/bin
cp /go/src/github.com/mesosphere/mesos-dns/mesos-dns $PKG_PATH/bin/mesos-dns


# Create the service file
service="$PKG_PATH"/dcos.target.wants_master/mesos-dns.service
mkdir -p "$(dirname "$service")"
cat <<EOF > "$service"
[Unit]
Description=Mesos DNS
[Service]
TimeoutStartSec=0
EnvironmentFile=/etc/environment
EnvironmentFile=/opt/mesosphere/environment
ExecStart=$PKG_PATH/bin/mesos-dns --config=/opt/mesosphere/etc/mesos-dns.json
EOF
