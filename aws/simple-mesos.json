{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Launches a Mesos cluster",

  "Parameters" : {
    "KeyName" : {
      "Description" : "Name of SSH key to link",
      "Type" : "AWS::EC2::KeyPair::KeyName"
    }
  },

  "Mappings" : {
    "Parameters" : {
      "MesosSlaveTemplateUrl" : { "default" : "https://s3.amazonaws.com/downloads.mesosphere.io/cloudformation/dcos/stage-mesos-slave.json" },
      "MesosMasterTemplateUrl" : { "default" : "https://s3.amazonaws.com/downloads.mesosphere.io/cloudformation/dcos/stage-mesos-master.json" },
      "VpcTemplateUrl" : { "default" : "https://s3.amazonaws.com/downloads.mesosphere.io/cloudformation/dcos/stage-vpc.json" },
      "BootstrapRepoRoot" : { "default" : "http://s3.amazonaws.com/downloads.mesosphere.io/dcos/pkgpanda/" } ,
      "DockerCredentials" : { "default" : "{}" },
      "InstanceAmi" : { "default" : "ami-fd361fcd" },
      "MasterQuorumCount" : { "default" : "1" },
      "SlaveInstanceCount" : { "default" : "4" },
      "MasterInstanceCount" : { "default" : "1" },
      "SlaveInstanceType" : { "default" : "m3.large" },
      "MasterInstanceType" : { "default" : "m3.large" },
      "AdminLocation" : { "default" : "0.0.0.0/0" },
      "ClusterId" : { "default" : "mesos" }
    }
  },

  "Resources" : {

    "VpcStack" : {
      "Type" : "AWS::CloudFormation::Stack",
      "Properties" : {
        "TemplateURL" : { "Fn::FindInMap" : [ "Parameters", "VpcTemplateUrl", "default" ] },
        "TimeoutInMinutes" : "5",
        "Parameters" : {
          "AdminLocation" : { "Fn::FindInMap" : [ "Parameters", "AdminLocation", "default" ] }
        }
      }
    },
    "MesosMasterStack" : {
      "Type" : "AWS::CloudFormation::Stack",
      "DependsOn" : "VpcStack",
      "Properties" : {
        "TemplateURL" : { "Fn::FindInMap" : [ "Parameters", "MesosMasterTemplateUrl", "default" ] },
        "TimeoutInMinutes" : "30",
        "Parameters" : {
          "InstanceAmi" : { "Fn::FindInMap" : [ "Parameters", "InstanceAmi", "default" ] },
          "InstanceType" : { "Fn::FindInMap" : [ "Parameters", "MasterInstanceType", "default" ] },
          "KeyName" : { "Ref" : "KeyName" },
          "InstanceCount" : { "Fn::FindInMap" : [ "Parameters", "MasterInstanceCount", "default" ] },
          "QuorumSize" : { "Fn::FindInMap" : [ "Parameters", "MasterQuorumCount", "default" ] },
          "VpcId" : { "Fn::GetAtt" : [ "VpcStack", "Outputs.VpcId" ] },
          "Subnets" : { "Fn::GetAtt" : [ "VpcStack", "Outputs.Subnet" ] },
          "AvailabilityZones": { "Fn::GetAtt" : [ "VpcStack", "Outputs.AvailabilityZone" ] },
          "BootstrapRepoRoot" : { "Fn::FindInMap" : [ "Parameters", "BootstrapRepoRoot", "default" ] },
          "AdminSecurityGroup" : { "Fn::GetAtt" : [ "VpcStack", "Outputs.AdminSecurityGroup" ] }
        }
      }
    },
    "MesosSlaveStack" : {
      "Type" : "AWS::CloudFormation::Stack",
      "DependsOn" : "MesosMasterStack",
      "Properties" : {
        "TemplateURL" : { "Fn::FindInMap" : [ "Parameters", "MesosSlaveTemplateUrl", "default" ] },
        "TimeoutInMinutes" : "30",
        "Parameters" : {
          "InstanceAmi" : { "Fn::FindInMap" : [ "Parameters", "InstanceAmi", "default" ] },
          "InstanceType" : { "Fn::FindInMap" : [ "Parameters", "SlaveInstanceType", "default" ] },
          "KeyName" : { "Ref" : "KeyName" },
          "InstanceCount" : { "Fn::FindInMap" : [ "Parameters", "SlaveInstanceCount", "default" ] },
          "MesosMasterSecurityGroup" : { "Fn::GetAtt" : [ "MesosMasterStack", "Outputs.MesosMasterSecurityGroup" ] },
          "MesosMaster" : { "Fn::GetAtt" : [ "MesosMasterStack", "Outputs.MesosMasterConnectString" ] },
          "MesosMasterInternalELB" : { "Fn::GetAtt" : [ "MesosMasterStack", "Outputs.MesosMasterInternalELB" ] },
          "MesosMasterLBSecurityGroup" : { "Fn::GetAtt" : [ "MesosMasterStack", "Outputs.MesosMasterLBSecurityGroup" ]},
          "VpcId" : { "Fn::GetAtt" : [ "VpcStack", "Outputs.VpcId" ] },
          "Subnets" : { "Fn::GetAtt" : [ "VpcStack", "Outputs.Subnet" ] },
          "AvailabilityZones": { "Fn::GetAtt" : [ "VpcStack", "Outputs.AvailabilityZone" ] },
          "BootstrapRepoRoot" : { "Fn::FindInMap" : [ "Parameters", "BootstrapRepoRoot", "default" ] },
          "AdminSecurityGroup" : { "Fn::GetAtt" : [ "VpcStack", "Outputs.AdminSecurityGroup" ] }
        }
      }
    }
  }
}
