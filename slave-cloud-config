#cloud-config
coreos:
  units:
    - name: systemd-resolved.service
      mask: true
      command: stop
    - name: bootstrap.service
      command: start
      content: |
        [Unit]
        Description=Bootstrap DCOS
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStartPre=/usr/bin/wget -nv https://s3.amazonaws.com/downloads.mesosphere.io/dcos/bootstrap.sh -O /bootstrap.sh
        ExecStartPre=/usr/bin/chmod +x /bootstrap.sh
        ExecStart=/bootstrap.sh
    - name: config-writer.service
      command: start
      content: |
        [Unit]
        Description=Write out dynamic config values
        [Service]
        RestartSec=10sec
        Restart=always
        ExecStartPre=/usr/bin/bash -c "/usr/bin/systemctl set-environment EC2_PUBLIC_HOSTNAME=$(curl -s http://169.254.169.254/latest/meta-data/public-hostname)"
        ExecStart=/usr/bin/bash -c 'touch /etc/mesosphere/cloudenv-dyn && echo "EC2_PUBLIC_HOSTNAME=${EC2_PUBLIC_HOSTNAME}" > /etc/mesosphere/cloudenv-dyn'
    - name: mesos-resolv.service
      command: start
      content: |
        [Unit]
        Description=Mesos-resolv
        After=cfn-signal.service
        [Service]
        TimeoutStartSec=0
        ExecStartPre=-/usr/bin/docker kill mesos-resolv
        ExecStartPre=-/usr/bin/docker rm mesos-resolv
        ExecStartPre=/usr/bin/docker pull mesosphere/mesos-resolv:master
        ExecStart=/bin/sh -c 'docker run --name=mesos-resolv -t mesosphere/mesos-resolv:master { "Ref" : "MesosMasterInternalELB" } > /etc/resolv.conf'
    - name: mesos-slave.service
      command: start
      content: |
        [Unit]
        Description=Mesos Slave
        After=bootstrap.service
        After=config-writer.service
        Requires=bootstrap.service
        EnvironmentFile=/etc/mesosphere/cloudenv-dyn
        [Service]
        Restart=on-failure
        ExecStart=/opt/mesosphere/dcos/latest/mesos/sbin/mesos-slave \
        --master={ "Ref" : "MesosMaster" } \
        --containerizers=docker,mesos \
        --hostname=${EC2_PUBLIC_HOSTNAME} \
        --log_dir=/var/log/mesos \
        --executor_registration_timeout=5mins \
        --isolation=cgroups/cpu,cgroups/mem \
        --work_dir=/var/lib/mesos/slave
    - name: cfn-signal.service
      command: start
      content: |
        [Unit]
        Description=Signal CloudFormation Success
        After=bootstrap.service
        Requires=bootstrap.service
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStartPre=/usr/bin/docker pull mbabineau/cfn-bootstrap
        ExecStartPre=/usr/bin/docker pull mbabineau/cfn-bootstrap
        ExecStart=/usr/bin/docker run --rm mbabineau/cfn-bootstrap \
          cfn-signal -e 0 \
          --resource ServerGroup \
          --stack { "Ref" : "AWS::StackName" } \
          --region { "Ref" : "AWS::Region" }

write_files:
    - path: /etc/mesosphere/cloudenv
      permissions: 0644
      owner: root
      content: |
        AWS_REGION={ "Ref" : "AWS::Region" }
        STACKNAME={ "Ref" : "AWS::StackName" }
        MESOS_MASTER_INTERNAL_ELB={ "Ref" : "MesosMasterInternalELB" }
        MESOS_MASTER_CONNECT_STRING={ "Ref" : "MesosMaster" }
        SLAVE_INSTANCE_COUNT={ "Ref" : "InstanceCount" }
        MACHINE_IMAGE={ "Ref" : "InstanceAmi" }
