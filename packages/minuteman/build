#!/bin/bash
set -x

source /opt/mesosphere/environment

cat <<EOF > /tmp/ssh_key
-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAlx2LbgvANOMyMvCVTQbL/f2CZ+qySFSt1Tw8vSzsXYWFNCvt
5EHTJuymU/148PmObLykANnu4/SlbEqppu1olfTPPBC6U5Hi0HfC2G+TRjm6Sy3G
DXtmH2a7Kex0rpV8fa0/XNmKG6EJ2PsnDkdtlADVqg9sA03QKl7CFW1OSMP0Wykc
GxZTzsE2WMTqfEVVH5Irh8mbXl0gGrsGTpyQ1ytDlWXypK0ZfQKkQKlLYb94YGFn
imkERfZwzq4pDA2m6pXYXLnmiLgV5v/9RrdDwMb3StKXva6VvGud+8E/mNuG1Bqg
4Q+HwblTmpqefpML0Kg8opp50a5RBQGOAVNt3wIDAQABAoIBAC+bCR/D5+tBX8EY
dZBsgbskL/7Yuw16T8ELVv8ptdTIiWwkIq9z5Tcv+j4fbghMNggfbXMvNMjve2Wg
J84EoJwNIXQEuQ42uUN/VwykKbtH2F5yrx/0LfnafT/509BkG3HkMD/p8E4/70BB
7s3axrSHhsgqT5bC3r9aVr41TyIwzUnHA6C81rtfBCLvYjkMm+8h3o48Kh9atMaE
nosbi9Q+RrAOc4Pgx+aLDXgygMbChGl6xPfdNcGFJ5GrcStArgEKsoblLjE390uM
hCxtCQDl/FDkKJD7hevgXb/R4CeAACPVC4X0kA4pBFUa/PcTvE86ZgjdYwCkx+5S
sWLqwnECgYEAyF4cZRPYRzoEQo+T4fNvD3Nr6sm4zC92+wbQPM71+MoyA6fMvYdR
6AGBHJekvwHzTz+tallUn7udse7s+r8s8rFmau7WLEZfim41Oa+Iec9W3f9YFrgb
VvINJ44P29skA7ZYu0F4WQHdlNB0WY/zWQxCDlUZQyL+i0GK1DpZ+HUCgYEAwRKl
VdgX/UCsMbwBIdL5xanLw+csZ/nLSTHbZgiD6dDJAQ79FA20Uthw1w0VALcl99PP
wiMwpLxnj9hNaKTKxB98HH2KliWaFQmx5OJIr6HYfM1lAo68v2F3N3YnbuIxud/e
heMK8bXNLqGvmu8pJFWpsV/jUe+jSp9yqYnq4oMCgYBoXu13kWDFqWjyqwujVUTy
zXLXeIB0i/z0QdZS9pOWJuzqjovN5iE6Mx5oIG3GuWNeUpMopKO6GObJ+uUisFbf
jJ0G8qZJpda6qzG6fL8ghGqBdTMTko9bOPa1NgD4yyv1axTJZg8kfh5IGFWjGaLv
Lb1y7c0c9auWKmwApOycyQKBgBRBvI8RKRMtIePl8ch2tjYC5pobOxF9p9J6JKbD
5fM2MKCnze24sl6uzsgBW17D2Hv0ASxBPO1LxyHUc+qyv4NsOj1S/qNaNpxWdA+r
niyvMmOFuT9Xcn4x36w1/VUo7kauMk6hz5gklu55kE8VIJ/rTO6LPPJvzhYaPJGF
Itu5AoGAJxDvR9MRKDu47wIB0lil/7Ct0h1V/dG3D6DrjkXuudDYOXzz3w9R4Yl+
tJNOBImtGT68n1NiyAO5Pjso6qiUKf9ZNiJi34Q0wk0LIXyNKh30C0nFljOAcNgJ
2fQo/uRXnKY+s48mit/vpSWaD4YBycTOypA9JRK/HofXK2r8Ziw=
-----END RSA PRIVATE KEY-----
EOF

mkdir -p ~/.ssh

cat <<EOF > ~/.ssh/config
Host *
  IdentityFile /tmp/ssh_key
  StrictHostKeyChecking no
  ForwardAgent yes
EOF

eval `ssh-agent`

chmod 600 /tmp/ssh_key

ssh-add /tmp/ssh_key


pushd /pkg/src/minuteman
make rel
popd

cp -r /pkg/src/minuteman/_build/prod/rel/minuteman ${PKG_PATH}

service=${PKG_PATH}/dcos.target.wants/dcos-minuteman.service
mkdir -p $(dirname $service)
cat <<EOF > $service
[Unit]
Description=Minuteman
After=dcos-gen-resolvconf.service
After=dcos-epmd.service
BindsTo=dcos-epmd.service

[Service]
Restart=always
StartLimitInterval=0
RestartSec=5
WorkingDirectory=${PKG_PATH}/minuteman
EnvironmentFile=/opt/mesosphere/environment
ExecStartPre=/bin/ping -c1 ready.spartan
ExecStartPre=/usr/bin/env mkdir -p /var/lib/dcos/minuteman/mnesia
ExecStartPre=/usr/bin/env mkdir -p /var/lib/dcos/minuteman/lashup
ExecStart=${PKG_PATH}/minuteman/bin/env foreground
Environment=HOME=/opt/mesosphere
EOF
