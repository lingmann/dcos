#!/bin/bash

mkdir -p "/build"

export CFLAGS=-I/opt/mesosphere/include
export LDFLAGS="-L/opt/mesosphere/lib -Wl,-rpath=/opt/mesosphere/lib"
export CXXFLAGS=-I/opt/mesosphere/include

#pushd "/pkg/src/linux"
#popd

#pushd "/pkg/src/flex"
#./configure \
#  "--prefix=$PKG_PATH"
#make -j8
#make install
#popd

#pushd "/pkg/src/bison"
#./configure \
#  "--prefix=$PKG_PATH"
#make -j8
#make install
#popd

#pushd "/pkg/src/popt"
#./configure \
#  "--prefix=$PKG_PATH"
#make -j8
#make install
#popd

#pushd "/pkg/src/libnl"
#./configure \
#  "--prefix=$PKG_PATH"
#make -j8
#make install
#popd

apt-get update
apt-get -y install libnl-3-dev libnl-genl-3-dev libpopt-dev linux-headers-3.19.0-21-generic pkg-config

pushd "/pkg/src/keepalived"
./configure \
  "--prefix=$PKG_PATH" \
  "--enable-sha1"
make -j8
make install
popd

mkdir -p "$PKG_PATH/lib"
cp /lib/x86_64-linux-gnu/libnl-genl-3.so.200 "$PKG_PATH/lib/libnl-genl-3.so.200"
cp /lib/x86_64-linux-gnu/libnl-3.so.200 "$PKG_PATH/lib/libnl-3.so.200"

systemd_master="$PKG_PATH"/dcos.target.wants_master/keepalived.service
mkdir -p "$(dirname "$systemd_master")"
cat <<EOF > "$systemd_master"
[Unit]
Description=LVS and VRRP High Availability Monitor
After=syslog.target network.target
ConditionPathExists=/opt/mesosphere/etc/keepalived

[Service]
Restart=on-failure
StartLimitInterval=0
RestartSec=5
EnvironmentFile=/etc/environment
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/opt/mesosphere/etc/keepalived
ExecStart=$PKG_PATH/keepalived/sbin/keepalived -n \$KEEPALIVED_OPTIONS
ExecReload=/bin/kill -HUP \$MAINPID
EOF
