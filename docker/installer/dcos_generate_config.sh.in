#!/bin/bash
# variant: {variant}
set -o errexit -o nounset -o pipefail

# preflight checks
docker version >/dev/null 2>&1 || {{ echo >&2 "docker should be installed and running. Aborting."; exit 1; }}

# extract payload and load into docker if not extracted
if [ ! -f "{genconf_tar}" ]
then
    echo Extracting image from this script and loading into docker daemon, this step can take a few minutes
    sed '0,/^#EOF#$/d' $0 | tar xv
    docker load -i {genconf_tar}
fi

echo "Running mesosphere/dcos-genconf docker with BUILD_DIR set to $PWD/genconf"
if [ ! -d genconf/state ]; then
    mkdir -p genconf/state
fi

PORT=${{PORT:-9000}}
trap 'kill -INT $PID' HUP INT TERM

setsid docker run -i -p $PORT:9000 -v $(pwd)/genconf/:/genconf {docker_image_name} "$@" &
PID=$!

wait $PID
exit $?
