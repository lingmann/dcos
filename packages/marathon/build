#!/bin/bash

mkdir -p "$PKG_PATH/usr/"

cp -rp /pkg/src/marathon/target/scala-2.11/marathon-assembly-*.jar "$PKG_PATH/usr/marathon.jar"
sudo chmod -R o+r "$PKG_PATH/usr"

marathon_service="$PKG_PATH/dcos.target.wants_master/marathon.service"
mkdir -p $(dirname "$marathon_service")

cat <<EOF > "$marathon_service"
[Unit]
Description=Marathon
After=mesos-master.service
Requires=mesos-master.service
[Service]
Restart=on-failure
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/opt/mesosphere/etc/cloudenv
ExecStart=/opt/mesosphere/bin/java -jar "$PKG_PATH/usr/marathon.jar" --zk zk://localhost:2181/marathon --master zk://localhost:2181/mesos --hostname "\$MARATHON_HOSTNAME" --default_accepted_resource_roles "*" --mesos_role "slave_public"
EOF
